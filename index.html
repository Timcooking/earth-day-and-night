<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>地球自转与日夜实时模拟</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="./styles/style.css" rel="stylesheet" />
  </head>
  <body>
    <div id="app">
      <header class="hud">
        <div class="brand">EARTH</div>
        <div class="controls">
          <div class="clock">
            <label><span data-i18n="label.nowTime">现在时间</span> <span id="clock">--:--:--</span></label>
          </div>
          <label>
            <span data-i18n="label.timezone">时区</span>
            <select id="timezone"></select>
          </label>
          <label class="toggle">
            <input id="auto-orbit" type="checkbox" checked />
            <span data-i18n="toggle.autoOrbit">自动环绕</span>
          </label>
          <label class="toggle">
            <input id="show-stars" type="checkbox" checked />
            <span data-i18n="toggle.showStars">星空</span>
          </label>
          <button id="lang-toggle" title="Switch language">EN</button>
          <button id="about-toggle" title="About / 关于" data-i18n="btn.about">关于</button>
          <button id="learn-toggle" title="Learn / 科普" data-i18n="btn.learn">你可能想知道...</button>
        </div>
      </header>
      <div id="canvas-container"></div>
  <div id="tooltip" role="status" aria-live="polite" style="display:none"></div>
      <footer class="legend">
        <div class="scale">
          <span data-i18n="legend.daylight">日照</span>
          <div class="bar"><i></i></div>
          <span data-i18n="legend.night">夜晚</span>
        </div>
        <div class="hint" data-i18n="hint.controls">拖拽旋转 / 滚轮缩放 / 右键平移</div>
      </footer>

      <!-- 右侧科普资料面板 -->
      <aside id="learn-panel" aria-label="Learn panel">
        <h3 data-i18n="panel.learn">科普</h3>
        <section>
          <h4 data-i18n="panel.kids">适合儿童</h4>
          <ul>
            <li>
              <a href="https://spaceplace.nasa.gov/" target="_blank" rel="noopener">NASA Space Place</a>
              <p>Games, videos, and activities about Earth and space for kids.</p>
            </li>
            <li>
              <a href="https://www.esa.int/kids/en" target="_blank" rel="noopener">ESA Kids</a>
              <p>欧洲航天局的儿童天地，探索太空与地球。</p>
            </li>
            <li>
              <a href="https://scijinks.gov/" target="_blank" rel="noopener">NOAA SciJinks</a>
              <p>气象与地球科学的有趣知识与小游戏。</p>
            </li>
          </ul>
        </section>
        <section>
          <h4 data-i18n="panel.earth">地球观测</h4>
          <ul>
            <li>
              <a href="https://earthobservatory.nasa.gov/" target="_blank" rel="noopener">NASA Earth Observatory</a>
              <p>来自太空的地球影像与解读。</p>
            </li>
            <li>
              <a href="https://eyes.nasa.gov/apps/earth/#/" target="_blank" rel="noopener">NASA Eyes: Earth</a>
              <p>交互式地球应用，浏览地球实时与历史数据。</p>
            </li>
          </ul>
        </section>
        <section>
          <h4 data-i18n="panel.solar">太阳系</h4>
          <ul>
            <li>
              <a href="https://solarsystem.nasa.gov/" target="_blank" rel="noopener">NASA Solar System</a>
              <p>行星、卫星、小行星与任务资料。</p>
            </li>
          </ul>
        </section>
      </aside>

      <!-- 关于弹窗 -->
      <div id="about-modal" role="dialog" aria-modal="true" aria-labelledby="about-title">
        <div class="card" role="document">
          <div class="card-head">
            <h3 id="about-title" data-i18n="about.title">关于这个页面</h3>
            <button id="about-close" class="close" aria-label="Close" data-i18n="about.close">关闭</button>
          </div>
          <div class="card-body">
            <p data-i18n="about.p1">这是一个使用 Three.js 实时渲染的地球模拟：展示日夜分界、云层与星空，镜头可拖拽旋转与自动环绕。</p>
            <p data-i18n="about.p2">你可以从上方选择时区，顶部时钟会显示该时区的当前时间；将鼠标悬停在国家上可查看名称与相关信息链接。</p>
            <h4 data-i18n="about.controls">基本操作</h4>
            <ul>
              <li data-i18n="about.ctrl.drag">拖拽旋转地球</li>
              <li data-i18n="about.ctrl.zoom">滚轮缩放视距</li>
              <li data-i18n="about.ctrl.pan">右键拖拽平移</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Import map 让 examples 模块解析到 three 主库 -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <!-- 错误叠层（WebGL/模块加载问题） -->
    <div id="overlay" role="dialog" aria-live="assertive" aria-modal="true" style="display:none">
      <div class="card">
        <h2 id="overlay-title">加载异常</h2>
        <p id="overlay-msg">请检查网络或浏览器对 WebGL 的支持。</p>
        <pre id="overlay-detail" style="display:none"></pre>
        <div class="actions">
          <button id="overlay-retry">重试</button>
        </div>
      </div>
    </div>

    <!-- 运行前置：WebGL 检测与错误处理工具 -->
    <script>
      window.__EARTH__ = window.__EARTH__ || {};
      window.__EARTH__.hasWebGL = function(){
        try {
          const c = document.createElement('canvas');
          return !!(window.WebGL2RenderingContext && c.getContext('webgl2')) || !!c.getContext('webgl') || !!c.getContext('experimental-webgl');
        } catch(e) { return false; }
      }
      window.__EARTH__.showOverlay = function(title, msg, detail){
        const el = document.getElementById('overlay');
        if (!el) return;
        el.style.display = 'flex';
        document.getElementById('overlay-title').textContent = title || '加载异常';
        document.getElementById('overlay-msg').textContent = msg || '';
        const pre = document.getElementById('overlay-detail');
        if (detail) { pre.style.display = 'block'; pre.textContent = String(detail).slice(0, 2000); } else { pre.style.display = 'none'; pre.textContent = ''; }
      }
      window.__EARTH__.hideOverlay = function(){ const el = document.getElementById('overlay'); if (el) el.style.display = 'none'; }
      // 绑定重试
      window.addEventListener('DOMContentLoaded', function(){
        const btn = document.getElementById('overlay-retry');
        if (btn) btn.addEventListener('click', ()=>{ window.location.reload(); });
      });
      // 预检测 WebGL
      (function(){
        if (!window.__EARTH__.hasWebGL()) {
          window.__EARTH__.showOverlay('浏览器不支持 WebGL', '请使用 Chrome/Edge 最新版并开启硬件加速，或更新显卡驱动。');
        }
      })();
    </script>

    <!-- 以动态导入方式加载主模块，便于捕获错误 -->
    <script type="module">
      if (window.__EARTH__ && window.__EARTH__.hasWebGL()) {
        import('./js/main.js').catch(err => {
          window.__EARTH__.showOverlay('模块加载失败', '可能是网络（CDN）或文件路径问题。建议切换网络或使用本地静态服务器。', err && (err.stack || err.message || err));
        });
      }
    </script>
  </body>
</html>
