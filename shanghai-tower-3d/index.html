<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="上海中心大厦 3D 模型展示 - Three.js 实现，支持滑动浏览与云层穿透效果" />
  <title>上海中心大厦 3D 模型展示</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="errorBanner" style="position:fixed;left:0;right:0;top:0;z-index:1000;display:none;background:#ff5b5b;color:#fff;padding:8px 12px;font:600 13px/1.6 ui-sans-serif,system-ui;">
    <span id="errorText">加载中…</span>
  </div>
  <!-- 顶部栏：标题 + 楼层指示 + 进度条 -->
  <header class="topbar" role="banner">
    <div class="brand">
      <h1>上海中心大厦 · 3D</h1>
      <small>滑动滚轮或拖动以浏览高度</small>
    </div>
    <div class="indicators" aria-live="polite">
      <div class="current-floor">当前楼层：<span id="currentFloor">1</span> / 128</div>
      <div class="current-height">高度：<span id="currentHeight">0</span> m</div>
    </div>
    <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
  </header>

  <!-- 侧边快速楼层导航（可滚动） -->
  <nav class="sidebar" aria-label="楼层导航">
    <ul id="floorList" tabindex="0" role="listbox" aria-activedescendant="floor-1"></ul>
  </nav>

  <!-- 3D 画布容器 -->
  <main class="stage" role="main">
    <canvas id="webgl" aria-label="上海中心 3D 视图" tabindex="0"></canvas>
  </main>

  <!-- 楼层详情模态框 -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc" hidden>
    <div class="modal__backdrop" data-close></div>
    <section class="modal__panel" role="document">
      <button class="modal__close" aria-label="关闭" data-close>×</button>
      <h2 id="modalTitle">楼层详情</h2>
      <div id="modalContent" class="modal__content">
        <!-- 动态注入：图片、文案 -->
      </div>
    </section>
  </div>

  <!-- 辅助 UI：提示 -->
  <div class="hint">
    <span>滚轮/触摸滑动 · 上/下方向键切换楼层 · 点击楼层查看详情 · + / - 缩放视图</span>
  </div>

  <!-- WebGL 支持与错误捕获（在模块加载前运行） -->
  <script>
    (function(){
      function showError(msg){
        var eb=document.getElementById('errorBanner');
        var et=document.getElementById('errorText');
        if(!eb||!et) return; et.textContent=msg; eb.style.display='block';
      }
      // 基本 WebGL 检测
      try {
        var c=document.createElement('canvas');
        var ok=!!(c.getContext('webgl2')||c.getContext('webgl')||c.getContext('experimental-webgl'));
        if(!ok){ showError('您的浏览器/设备未启用 WebGL，3D 无法显示。请在 Chrome/Edge 最新版并开启硬件加速，或更新显卡驱动。'); }
      } catch(e){ showError('WebGL 检测失败：'+e.message); }
      // 捕获脚本与网络错误（CDN 无法访问等）
      window.addEventListener('error', function(e){ showError('脚本错误：'+(e.message||'未知错误')+'（请按 F12 打开控制台查看详情）'); });
      window.addEventListener('unhandledrejection', function(e){ showError('模块/网络错误：可能无法访问 CDN。建议使用 VS Code Live Server 打开或检查网络。'); });
    })();
  </script>

  <!-- Import Map：将裸模块名 three 映射到 jsDelivr 的 ESM 构建 -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.module.js"
      }
    }
  </script>

  <!-- 模块化脚本：ES Modules from CDN + 本地模块 -->
  <script type="module" src="main.js"></script>
</body>
</html>
